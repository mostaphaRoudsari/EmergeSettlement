<html lang="en">
	
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <meta name="description" content="">
	    <meta name="author: Mostapha Roudsari" content="">

		<title>e[m]ergy settlement</title>
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> <!-- D3 -->
	    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

		<script src = "./js/pace.min.js"></script>	
		<style src = "./css/pace.css"></style>

		<!-- Bootstrap Core CSS -->
	    <link href="base_bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="base_bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

	<style>
		body {
		   font-family: sans-serif;
		   font-size: 12px;
		}

		input {
		   display: inline-block;
		   font-family: sans-serif;
		   font-size: 12px;
		}

		output {
		    display: inline-block;
		   	font-size: 11px;
		   	font-weight: bold;
		    color: red;
		     }

	</style>

	</head>

<body>

	<script type="text/javascript">
		// sliders
		var energyDemand = 1.0,
			EDPV = 0.0,
			EDBioMass = 0.1,
			EDWind = 0.0,
			EDFuel = 0.9,
			FoodDemand = 1.0,
			FDGrains = 0.46,
			FDVegetables = 0.12,
			FDFruit = 0.08,
			FDDairy = 0.05,
			FDMeat = 0.23,
			FDFish = 0.05,
			MileDriven = 1.0,
			VehicleEff = 1.0,
			GasolineMix = 0.1;

		var sumEnergyMixValues = function checkEnergyMixValues(){
			
			return (EDFuel + EDPV + EDWind + EDBioMass).toFixed(1);
		}


		var sumDietMixValues = function checkDietMixValues(){
			return (FDGrains + FDVegetables + FDFruit + FDDairy + FDMeat + FDFish).toFixed(1);
		}

	</script>

	    <!-- Page Content -->
	    <div class="row-fluid">
	      	<div id="tableWrapper" class="col-xs-2">
	      		<div class="col-xs-12">
	      			<h3>DENSITY</h3>
	                <form oninput="amount.value=nDensity.value">
	                	2. Density: <output name="amount" for="nDensity">1.0</output>
	                	<input type="range" min="0.1" max="2.0" id="nDensity" value="1.0" step="0.1">
	        		</form>
	        	</div>
	      		<hr>
	      		<div class="row-fluid">
                	<div id = "table" class="col-xs-12">
	            		<h3>POPULATION</h3>
	            	</div>
	            </div>
	            
	            <div class="row-fluid">
                	<div id = "totalPopulation" class="col-xs-12">
	            	</div>
	            </div>
	    	</div>

	    	<!-- map -->
	        <div id="grid" class="col-xs-6">
	            <!--
	            <h3>MAP</h3>
	            <span style:"font-size:12px"> Hover the mouse on circles to see name and population. 
				Drag circles to relocate the cities - Right click to change population! Loading data will take few seconds...</span>
				-->
	        </div>
	    
	    	<!-- sliders and eventually graphs -->
	        <div id="sliders" class="col-xs-4">
                <h3>SCENARIO SETUP</h3>
                <div class="row-fluid">
                	<div class="col-xs-12">
                		<button id="play" type="button">RUN THIS SCENARIO!</button>
	                </div>
	        	</div>
                
                <div class="row-fluid">
		            <hr>
		            <div class="col-xs-12">
		                <form oninput="amount.value=nEnergyDemand.value">
		                	3. Energy Demand: <output name="amount" for="nEnergyDemand">1.0</output>
		                	<input type="range" min="0.1" max="2.0" id="nEnergyDemand" value="1.0" step="0.1">
		        		</form>
		        	</div>
		        	<div class="col-xs-6">
		        		<form oninput="amount.value=nEDFuel.value">
		                	7. Energy Mix - Fossil Fuel: <output class="EDFuel" name="amount" for="nEDFuel">0.9</output>
		                	<input type="range" min="0.0" max="1.0" id="nEDFuel" value="0.9" step="0.1" readonly="true">
		        		</form> 
		        	</div>
		        	<div class="col-xs-6">
		                <form oninput="amount.value=nEDPV.value">
		                	4. Energy Mix - PV: <output name="amount" for="nEDPV">0.0</output>
		                	<input type="range" min="0.1" max="1.0" id="nEDPV" value="0.0" step="0.1">
		        		</form>
		        	</div>
		        	<div class="col-xs-6">
		                <form oninput="amount.value=nEDBioMass.value">
		                	5. Energy Mix - BioMass: <output name="amount" for="nEDBioMass">0.1</output>
		                	<input type="range" min="0.0" max="1.0" id="nEDBioMass" value="0.1" step="0.1">
		        		</form>
		        	</div>
		        	<div class="col-xs-6">
		                <form oninput="amount.value=nEDWind.value">
		                	6. Energy Mix - Wind: <output name="amount" for="nEDWind">0.0</output>
		                	<input type="range" min="0.0" max="1.0" id="nEDWind" value="0.0" step="0.1">
		        		</form>
		        	</div>
				</div>

				<div class="row-fluid">
					<hr>
		            <div class="col-xs-12">
		                <form oninput="amount.value=nFoodDemand.value">
							8. Food Demand: <output name="amount" for="nFoodDemand">1.0</output>
							<input type="range" min="0.1" max="2.0" id="nFoodDemand" value="1.0" step="0.1">
		        		</form>
	                </div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDGrains.value">
							9. Diet - Grains: <output name="amount" for="nFDGrains">0.46</output>
							<input type="range" min="0.00" max="1.0" id="nFDGrains" value="0.46" step="0.01">
		        		</form>
		            </div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDVegetables.value">
							10. Diet - Vegetables: <output name="amount" for="nFDVegetables">0.13</output>
							<input type="range" min="0.00" max="1.00" id="nFDVegetables" value="0.13" step="0.01">
		        		</form>
		        	</div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDFruit.value">
							11. Diet - Fruit: <output name="amount" for="nFDFruit">0.08</output>
							<input type="range" min="0.00" max="1.00" id="nFDFruit" value="0.09" step="0.01">
		        		</form>
		        	</div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDDairy.value">
							12. Diet - Dairy: <output name="amount" for="nFDDairy">0.05</output>
							<input type="range" min="0.00" max="1.00" id="nFDDairy" value="0.05" step="0.01">
		        		</form>
		            </div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDMeat.value">
							13. Diet - Meat: <output name="amount" for="nFDMeat">0.23</output>
							<input type="range" min="0.00" max="1.00" id="nFDMeat" value="0.23" step="0.01">
		        		</form>
		            </div>
		            <div class="col-xs-6">
		                <form oninput="amount.value=nFDFish.value">
							14. Diet - Fish: <output name="amount" for="nFDFish">0.05</output>
							<input type="range" min="0.00" max="1.00" id="nFDFish" value="0.05" step="0.01">
		        		</form>
		        	</div>
        		</div>

				<hr>
                <form oninput="amount.value=nMileDriven.value">
					15. Average miles Driven: <output name="amount" for="nMileDriven">1.0</output>
					<input type="range" min="0.1" max="2.0" id="nMileDriven" value="1.0" step="0.1">
        		</form>
                <form oninput="amount.value=nVehicleEff.value">
					18. Vehicle Efficiency: <output name="amount" for="nVehicleEff">1.0</output>
					<input type="range" min="0.1" max="2.0" id="nVehicleEff" value="1.0" step="0.1">
        		</form>
                <form oninput="amount.value=nGasolineMix.value">
					19. Gasoline Mix - Bio Fuels (Agriculture): <output name="amount" for="nGasolineMix">0.1</output>
					<input type="range" min="0.0" max="1.0" id="nGasolineMix" value="0.1" step="0.1">
        		</form>

            </div>
	    
	    </div>
	    <!-- /.row -->
	    <!-- /.container -->
	<script type="text/javascript">
		
		// sliders
		d3.select("#nEnergyDemand").on("input", function(){energyDemand = +this.value;});
		d3.select("#nEDFuel").on("input", function(){EDFuel = +this.value;}); // result of other sliders
		d3.select("#nEDPV").on("input", function(){EDPV = +this.value;});
		d3.select("#nEDBioMass").on("input", function(){EDBioMass = +this.value;});
		d3.select("#nEDWind").on("input", function(){EDWind = +this.value;});
		d3.select("#nFoodDemand").on("input", function(){FoodDemand = +this.value;});
		d3.select("#nFDGrains").on("input", function(){FDGrains = +this.value;}); // result of other sliders
		d3.select("#nFDVegetables").on("input", function(){FDVegetables = +this.value;});
		d3.select("#nFDFruit").on("input", function(){FDFruit = +this.value;});
		d3.select("#nFDDairy").on("input", function(){FDDairy = +this.value;});
		d3.select("#nFDMeat").on("input", function(){FDMeat = +this.value;});
		d3.select("#nFDFish").on("input", function(){FDFish = +this.value;});
		d3.select("#nMileDriven").on("input", function(){MileDriven = +this.value;});
		d3.select("#nVehicleEff").on("input", function(){VehicleEff = +this.value;});
		d3.select("#nGasolineMix").on("input", function(){GasolineMix = +this.value;});

	</script>


	<script type="text/javascript">

		var margin = { top: 0, right: 20, bottom: 100, left: 0 },
			width = window.innerWidth - 160;
			mapWidth = 10 * width /12 - margin.left - margin.right - 120,
			height = window.innerHeight + 20,
			mapHeight = height - margin.top - margin.bottom,
			colors = ["#137484", "#00A3DB", "#9BD956", "#E6385C", "#F5EA0B", "#3ECA66"],
			landuse = ["Wetlands", "Water", "Natural", "Developed", "Agriculture", "Forest"],
			cityname = "", // a public value to be used to change population of cities on click
			isFirstRun = true,
			totalPopulation = 0;

		
		// create population scale for circle radius
		var popScale = d3.scale.linear();

		// create color scale
		var colorscale = d3.scale.ordinal()
			.range(colors)
			.domain(landuse);

		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/settlements.json", function(settlements){

		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/bitmapdata.json", function(data){
		

		// population table - Based on: http://christopheviau.com/d3_tutorial/
		settlements.forEach(function(d){
			totalPopulation += +d.population;
		});

		popScale.domain(d3.extent(settlements, function(d){return d.population;}));

		var populationTable = d3.select("#table")
			.append("table")
		    .style("border-collapse", "collapse")
		    .style("border", "2px black solid")

		    .selectAll("tr")
		    .data(settlements)
		    .enter().append("tr")

			.selectAll("td")
		    .data(function(d){return [d.name, d.population];})
		    .enter().append("td")
		    .style("border", "1px black solid")
		    .style("padding", "5px")
		    .on("mouseover", function(){d3.select(this).style("background-color", "aliceblue")})
		    .on("mouseout", function(){d3.select(this).style("background-color", "white")})
		    .text(function(d){return d;})
		    .style("font-size", "12px")
		    .style("color", function(d){return (!isNaN(parseInt(d)))? "red":""})
		    .style("font-weight", function(d, i){return (!isNaN(parseInt(d)))? "bold":"normal"})
		    // .attr("contenteditable", function(d, i){return !isNaN(parseInt(d))}); //for this version we don't need it editable

		d3.select("#totalPopulation")
			.text("Total: " + totalPopulation)
			.style("padding-top", "10px")
			.style("font-size", "20px")
		    .style("color", "red")
		    .style("font-weight", "bold");

		// start creating the map
		var numOfColumns = data.numOfCol;
		var gridSize = mapWidth/numOfColumns;
		var cells = data.cells;
		// total area in acres is 1581470
		var totalArea = 1581470;
		var cellArea = 1581470 / Math.pow(numOfColumns, 2);

		popScale.range([2*gridSize, gridSize]);
		
		// update height
		mapHeight = Math.max(mapHeight, mapWidth);
		
		// take care of whitespace in city names
		settlements.forEach(function(d){d.nospacename = d.name.replace(" ", "\\ ")});

		// create base svg and add group for grid
		var svg = d3.select("#grid").append("svg")
			.attr("width", mapWidth)
			.attr("height", mapHeight)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");			
		
		
		function rankCities(d){
			// sort cities based on distance from this point
			d.distanceTo.sort(function(x, y){return d3.ascending(d3.values(x)[0], d3.values(y)[0]);
			// I'm not sure if I need this as object stay
		})

		}

		// add grid cells
		var grid = svg.selectAll("rect")
			.data(cells)
			.enter().append("rect")
				.attr("transform", function(d) {
					// set some other default values - I'm trying to save one extra loop by doing it here
					// not sure if it really helps
					d.isTaken = false;
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move cells to the right place
				.attr("width", gridSize)
				.attr("height", gridSize)
				.attr("class", "cells")
				.attr("id", function(d){return "id_" + d.id;})
				.style("fill", function(d){return colorscale(d.landuse);})

		// Added tooltip to make sure x - y values make sense
		// grid.append("title").text(function(d){return d.x + "|" + d.y;})
		
      	/*
      	// Define drag beavior
	    var drag = d3.behavior.drag()
	        .on("drag", function(d) {
	            d.x += d3.event.dx;
	            d.y += d3.event.dy;
	            //this.x = d.x;
	            //this.y = d.y;
	            d3.select(this).attr("transform", function(d){
	                return "translate(" + [d.x, d.y] + ")"
	            })
	        });
		*/

		// update population of the city
		updatePopulation = function updatePopulation() {
	        var thisCity = d3.select("#" + cityname);
	        var newPoulation = $("#new_population").val().trim();
	        $("#new_population").remove();
	        if (isNaN(parseInt(newPoulation))) return; // avoid invalid inputs
	        thisCity.data()[0].population = newPoulation;
			// update titles
			d3.selectAll(".cities").selectAll("title").text(function(d){return d.name + "> population: " + d.population;});
	    }

	    removeInputPanel = function removeInputPanel(){
	        $("#new_population").remove();
	    }

		// add one circle for each city
		var cities = svg.selectAll("circle")
			.data(settlements)
			.enter().append("circle")
				.attr("class", "cities")
				.attr("id", function(d){return d.name;})
				.attr("r", function(d){return popScale(d.population);})
				.attr("transform", function(d) {
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move circles to the right place
				.style("fill", "white")
				.style("stroke", "black")
				.style("stroke-width", "2px")
      			//.call(drag)
      			// for this version we decided not to change the population which is pretty sad if you ask me!
      			.on("contextmenu", function(d) {
                    $(".externalObject").remove();
                    cityname = d.nospacename;
                    svg.append("foreignObject")
                        .attr("class", "externalObject")
                        .attr("x", d.x)
                        .attr("y", d.y)
                        .attr("width", 160)
                        .attr("height", 24)
                        .append("xhtml:div")
                        .html("<input type='text' id=new_population placeholder='input new population' onkeydown ='{if (event.keyCode==13)updatePopulation()}; if (event.keyCode==27) {removeInputPanel();}'></input>")
                        //found this example here: http://stackoverflow.com/questions/23503936/javascript-d3-create-floating-textbox-on-click-and-update-graph-from-textbox-in
                		d3.event.preventDefault(); //stop showing browser menu
                });
      	/*
      	// add name of cities
      	svg.selectAll("text")
			.data(settlements)
			.enter().append("text")
      		.attr("x", function(d){ return d.x;})
      		.attr("y", function(d){ return d.y - 2.1*gridSize;})
      		.style("fill", "black")
      		.style("font-size", "12px")
      		.text(function(d){return d.name;});
		*/

		// add mouse over tooltip
		cities.append("title").text(function(d){return d.name + "> population: " + d.population;})
		// append title for each cell for mouse hover
		// I think it is useful once they are taken by any of the cities
		// grid.append("title").text("some text")

		function getDistance(x0, y0, x1, y1){
			// this is not the correct distance but since I just use it for comparison
			// I'm trying to save the extra step of sqrt
			return Math.pow((x1-x0),2) + Math.pow((y1-y0),2);
		}

		// check scenario
		function checkScenario(){
			if (sumDietMixValues() != 1){
				alert("Sum of diet values should be equal to 1.00\nCurrent sum: " + sumDietMixValues());
				return false;
			}
	       	
	       	if (sumEnergyMixValues() != 1){
	       		alert("Sum of energy mix values should be equal to 1.00\nCurrent sum: " + sumEnergyMixValues());
	       		return false;
			}
			
			return true;
		}


		// run the scenario
	    d3.select("#play")
	        .on("click", function() {
	        	if (!checkScenario()) return;
	        	/*
	        	d3.selectAll(".cells")
	        		.transition().duration(200)
	        		.style("opacity","0.2");
				*/
	        	// just for test running the first round
	        	for (var rank = 0; rank < 1; rank++) {
	        		
	        		settlements.forEach(function(settlement){
	        			var resources = settlement.sortedResourcesIds;
	        			var landuses = d3.keys(resources);
	        			landuses.forEach(function(landuse){
	        			var ids = resources[landuse][rank];
	        			console.log(ids);
	        			if(ids!=null){
	        				ids.forEach(function(id){
	        					d3.select("#id_" + id).remove();
	        						//.attr("fill", "black");
	        				});
	        			}

	        			});
	        		});
	        	}
	        });
	        	
    });

	});



	
	</script>


		<!--
	    <!-- /.footer
	    <div class="row-fluid">
	        <footer>
	            <div class="footer navbar-fixed-bottom col-xs-12">
	            <hr>
	                <p>
	                    March 2015 |
	                    <a href="https://github.com/mostaphaRoudsari/SettlementEmerge" target="_blank"> About</a>
	                </p>
	            </div>
	        </footer>
	    </div>
	    -->

	    <!-- jQuery Version 1.11.1 -->
	    <script src="base_bootstrap/js/jquery.js"></script>

	    <!-- Bootstrap Core JavaScript -->
	    <script src="base_bootstrap/js/bootstrap.min.js"></script>

</body>
	

</html>