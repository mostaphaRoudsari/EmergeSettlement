<html lang="en">
	
	<head>
		<meta charset="utf-8">
	    <meta http-equiv="X-UA-Compatible" content="IE=edge">
	    <meta name="viewport" content="width=device-width, initial-scale=1">
	    <meta name="description" content="">
	    <meta name="author: Mostapha Roudsari" content="">

		<title>e[m]ergy settlement</title>
		
		<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> <!-- D3 -->
	    
		<script type="text/javascript" src="https://ajax.cloudflare.com/cdn-cgi/nexp/dok3v=919620257c/cloudflare.min.js"></script>
	    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

		<script src="./rangeslider_files/js/ion.rangeSlider.js"></script>
		
		<link rel="stylesheet" href="./rangeslider_files/css/normalize.css" />
	    <link rel="stylesheet" href="./rangeslider_files/css/ion.rangeSlider.css" />
		<link rel="stylesheet" href="./rangeslider_files/css/ion.rangeSlider.skinNice.css"/>

		<script src = "./js/pace.min.js"></script>
		<style src = "./css/pace.css"></style>

		<!-- Bootstrap Core CSS -->
	    <link href="base_bootstrap/css/bootstrap.min.css" rel="stylesheet">
    	<link href="base_bootstrap/css/bootstrap-responsive.css" rel="stylesheet">

	<style>
		body {
		   font-family: sans-serif;
		   font-size: 12px;
		}

		input {
		   display: inline-block;
		   font-family: sans-serif;
		   font-size: 12px;
		}

		output {
		    display: inline-block;
		   	font-size: 11px;
		   	font-weight: bold;
		    color: red;
		}

		progress, #calcProgress, #progUpdate {
			float:left;
			margin-top:20px;			
		}
		
		progress, #calcProgress {
			margin-right:10px;
			width: 11.5em;
		}
		
		#progUpdate, #calcProgress{
			color:#000;
		}
		
		.hull {
		  fill: orange;
		  stroke: black;
		  stroke-width: 2px;
		  stroke-linejoin: round;
		  opacity: .5;
		}

		hr {
			color: black;
		}

		rect.disabled,
		text.disabled {
		fill: transparent !important;
		}

	</style>

	</head>

<body>

	<script type="text/javascript">
		// sliders
		var energyDemand = 1.0,
			EDPV = 0.0,
			EDBioMass = 0.1,
			EDWind = 0.0,
			EDFuel = 0.9,
			FoodDemand = 1.0,
			FDGrains = 0.46,
			FDVegetables = 0.12,
			FDFruit = 0.08,
			FDDairy = 0.05,
			FDMeat = 0.23,
			FDFish = 0.05,
			MileDriven = 1.0,
			VehicleEff = 1.0,
			GasolineMix = 0.1;

		var sumEnergyMixValues = function checkEnergyMixValues(){
			
			return 1 - (EDFuel + EDPV + EDWind + EDBioMass).toFixed(1) < 0.1;
		}


		var sumDietMixValues = function checkDietMixValues(){
			return FDGrains + FDVegetables + FDFruit + FDDairy + FDMeat + FDFish > 0.99;
		}

	</script>

	    <!-- Page Content -->
	    <div class="row-fluid">
		    <div id="title" class="col-xs-12">
		    		<h1>New Chautauqua  <span style = "font-size:0.6em"> Designing the Renewable City and Region Using e[m]ergy Accounting</span></h1>
		    </div>
	    </div>
	    
		<!-- don't remove the form -->
	    <form id="inputSliders">
	    <div class="row-fluid">
			<hr>
	    	<!-- sliders and eventually graphs -->
	        <div id="sliders" class="col-xs-4">
                
                <div class="row-fluid" style="background:#F0F0F0" title="Energy">
		            
		            <div class="col-xs-4" style="font-weight:bold; padding-top:20px">
					Energy Demand
					</div>

		            <div class="col-xs-8">
		                	<input type="text" name="nEnergyDemand" id="nEnergyDemand" value="100">
		        	</div>

		        	<div class="col-xs-12" style="font-weight:bold; padding-bottom:2px; padding-top:5px">
					Energy Production Efficiency
					</div>
		            <div class="col-xs-4">
		                	<input type="text" name="nPVEff" id="nPVEff" value="100">
		                	PV
		        	</div>
		            <div class="col-xs-4">
		                	<input type="text" name="nBioMassEff" id="nBioMassEff" value="100">
		                	Biomass
		        	</div>
		            <div class="col-xs-4">
		                	<input type="text" name="nWindEff" id="nWindEff" value="100">
		                	Wind
		        	</div>
					

					<div class="col-xs-12" style="font-weight:bold; padding-bottom:2px; padding-top:5px">
					Energy Mix
					</div>

		        	<div class="col-xs-3">
		        		<input type="text" name="nEDFuel" id="nEDFuel" value="84" step="1">
		        		Fossil Fuel
		        	</div>
		        	<div class="col-xs-3">
		                <input type="text" name="nEDPV" id="nEDPV" value="1" step="1">
		               	PV
		        	</div>
		        	<div class="col-xs-3">
	                	<input type="text" name="nEDBioMass" id="nEDBioMass" value="15" step="1">
	                	BioMass
		        	</div>
		        	<div class="col-xs-3">
	                	<input type="text" name="nEDWind" id="nEDWind" value="0" step="1">
	                	Wind
		        	</div>

				</div>
				<hr>
				<div class="row-fluid" style="background:#F0F0F0" title="Food">
					<div class="col-xs-4" style="font-weight:bold; padding-top:20px">
					Food Demand
					</div>
		            <div class="col-xs-8">
		                	<input type="text" name="nFoodDemand" id="nFoodDemand" value="100">
		        	</div>
					
					<div class="col-xs-4" style="font-weight:bold; padding-top:10px">
					Food Production Eff. Imporvement
					</div>
		            <div class="col-xs-8">
		                	<input type="text" name="nFoodEff" id="nFoodEff" value="100">
		        	</div>
					
					<div class="col-xs-12" style="font-weight:bold; padding-bottom:2px; padding-top:5px">
						Diet Mix
					</div>

		            <div class="col-xs-4">
							<input type="text" name="nFDGrains" id="nFDGrains" value="45">
							Grains
		            </div>
		            <div class="col-xs-4">
							<input type="text" name="nFDVegetables" id="nFDVegetables" value="15">
							Vegetables
		        	</div>
		            <div class="col-xs-4">
							<input type="text" name="nFDFruit" id="nFDFruit" value="10">
							Fruit
		        	</div>
		            <div class="col-xs-4">
							<input type="text" name="nFDDairy" id="nFDDairy" value="5">
							Dairy
		            </div>
		            <div class="col-xs-4">
							<input type="range" name="nFDMeat" id="nFDMeat" value="20">
							Meat
		            </div>
		            <div class="col-xs-4">
							<input type="text" name="nFDFish" id="nFDFish" value="5">
							Fish
		        	</div>
        		</div>
				<hr>
				<div class="row-fluid" style="background:#F0F0F0" title="Transportation">
					<div class="col-xs-4" style="font-weight:bold; padding-top:10px">
						Vehicle miles Driven - Per Capita
					</div>
		            <div class="col-xs-8">
		                	<input type="text" name="nMileDriven" id="nMileDriven" value="90">
		        	</div>
					
					<div class="col-xs-4" style="font-weight:bold; padding-top:10px">
						Vehicle Efficiency - MPG
					</div>
					<div class="col-xs-8">
						<input type="text" name="nVehicleEff" id="nVehicleEff" value="200">
        			</div>

					<div class="col-xs-4" style="font-weight:bold; padding-top:10px">
						Biofuel Production Efficiency
					</div>
					<div class="col-xs-8">
						<input type="text" name="nBioFuelEff" id="nBioFuelEff" value="100">
					</div>

	        		<div class="col-xs-12" style="font-weight:bold; padding-bottom:2px; padding-top:5px">
		        		Vehicle Fuel Mix
					</div>

	        		<div class="col-xs-4">
						<input type="text" name="nTMBiofuels" id="nTMBiofuels" value="11">
	        			Biofuels
	        		</div>
					<div class="col-xs-4">
						<input type="text" name="nTMElectricity" id="nTMElectricity" value="0">
	        			Electricty
	        		</div>
	        		<div class="col-xs-4">
						<input type="text" name="nTMFossilfuels" id="nTMFossilfuels" value="89">
	        			Fossil Fuel
	        		</div>
            	</div>
            </div>

	    	<!-- map -->
	        <div class="col-xs-8">
	            <!--
	            <h3>MAP</h3>
	            <span style:"font-size:12px"> Hover the mouse on circles to see name and population. 
				Drag circles to relocate the cities - Right click to change population! Loading data will take few seconds...</span>
				-->
				<div class="row-fluid">
					<div class="col-xs-4">
						<div class="row-fluid" style="background:#F0F0F0" title="Load different population scenarios. You can change population of each city by righ clicking on the circle and input a number. Use show populations button to see the population for each city.">
							<div class="col-xs-12" style="font-weight:bold; font-size:1.2em">
		                		1.Select the Population Scenario
		                		<select name="populationScenarios">
									  <option value="SC1" title="Each settlement point 'as is' with all population increases proportionate to that settlements ranking in the county.">Baseline Distribution</option>
									  <option value="SC2" title="All settlements have an equal share of the total population.">Even Distribution</option>
									  <option value="SC3" title="Takes the population and shares it evenly across two settlement points. (i.e. Jamestown and Dunkirk)">Two Centres</option>
									  <option value="SC4" title="All population in a single point (i.e. Jamestown)">One Centre</option>
								</select>
		            		</div>
		            	</div>
						<hr>
						<div class="row-fluid" style="font-weight:bold">
							<div id = "buttons" class="col-xs-12">
		                		<input type="submit" style="width:100%; font-size:1.2em" value="2.Check Land Area..."/><br><span id="result"> You need to calculate land area before remapping the landuse.</span>
				            </div>
						</div>
						<hr>
						<div class="row-fluid" style="font-weight:bold; font-size:1.2em">
					       	<div class="col-xs-12">
		                		<button style="width:100%" id="play" type="button">3.Remap Chautauqua!</button>
			                </div>
			                
			                <div class="col-xs-12">
								<progress style="width:100%" value="0" max="100" id="progBar">
							    	<span id="calcProgress">
							        	<!-- Fallback goes here -->
							    	</span>
								</progress>
			                </div>
			                <div id="progUpdate" class="col-xs-12">
			                		...
							    	<!-- Success Message -->
							</div>
						</div>
			        	<hr>						

						<div class="row-fluid" style="background:#F0F0F0" title="Developed Land">
							<div class="col-xs-12">
								<input type="text" id="nDensity" name="nDensity" value="100">
								Developed Land Density
							</div>
							<div class="col-xs-12">
								<input type="text" id="nBldgSizeEff" name="nBldgSizeEff" value="100">
								Building Size - Efficiency
							</div>
							<div class="col-xs-12">
								<input type="text" id="nBldgDepr" name="nBldgDepr" value="50">
								Deprecation of Buildings (Years)
							</div>
						</div>
						<hr>
						<div class="row-fluid" style="background:#F0F0F0" title="Consumption">
							<div class="col-xs-12">
								<input type="text" id="nGoodPurchased" name="nGoodPurchased" value="100">
								Goods Purchased
							</div>
							<div class="col-xs-12">
								<input type="text" id="nWasteProduced" name="nWasteProduced" value="100">
								Waste Produced
							</div>
							<div class="col-xs-12">
								<input type="text" id="nWasteRecycling" name="nWasteRecycling" value="100">
								Waste Recycling
							</div>
							<div class="col-xs-12">
								<input type="text" id="nWaterUsage" name="nWaterUsage" value="100">
								Water Usage - per capita
							</div>
						</div>
					</div>

					<div class="col-xs-8">
						<div class="row-fluid">
	                		<div id = "totalPopulation" class="col-xs-9"><h4>Total Population: <span></span></h4></div>
		            		<div class="col-xs-3">
	             				<button id="showCities" type="button">Show Populations</button>
		    				</div>
		            	</div>

						<div id="grid" class="col-xs-12"></div>
					</div>
				</div>
	        </div>

	    </div>
	</form>
	    <!-- /.row -->
	    <!-- /.container -->
	<script type="text/javascript">

		// set up sliders
	    jQuery( document ).ready(

	    	function($){
	        $("#nEnergyDemand").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });

	        $("#nPVEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
	        $("#nBioMassEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
	        $("#nWindEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });

	        $("#nEDPV").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",", keyboard: true
	            , keyboard_step: 1
	        });
	        $("#nEDBioMass").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",", keyboard: true
	            , keyboard_step: 1
	        });
	       	$("#nEDWind").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",", keyboard: true
	            , keyboard_step: 1
	        });
	        $("#nEDFuel").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",", keyboard: true
	            , keyboard_step: 1
	        });

	        $("#nFoodDemand").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
	        $("#nFoodEff").ionRangeSlider({
	            hide_min_max: true, min: 100, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });

	        $("#nFDGrains").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });
	        $("#nFDVegetables").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });
	       	$("#nFDFruit").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });
	        $("#nFDDairy").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });
	       	$("#nFDMeat").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });
	        $("#nFDFish").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 5, postfix:"%", grid: false, prettify_separator: ","
	        });

    		$("#nMileDriven").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
        	$("#nVehicleEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
			$("#nBioFuelEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, from: 100, step: 10, postfix:"%", grid: true, prettify_separator: ","
	        });
			$("#nTMBiofuels").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",",
	            keyboard: true, keyboard_step: 1
	        });
			$("#nTMElectricity").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",",
	            keyboard: true, keyboard_step: 1, disable: true
	        });
			$("#nTMFossilfuels").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 100, step: 1, postfix:"%", grid: false, prettify_separator: ",",
	            keyboard: true, keyboard_step: 1
	        });

	        $("#nDensity").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"%", grid: false, prettify_separator: ","
	        });
	        $("#nBldgSizeEff").ionRangeSlider({
	            hide_min_max: true, min: 0, max: 200, step: 10, postfix:"%", grid: false, prettify_separator: ",",
	            disable: true
	        });	        
	        $("#nBldgDepr").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"yr", grid: false, prettify_separator: ",",
	            disable: true
	        });
	       	
	       	$("#nGoodPurchased").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"yr", grid: false, prettify_separator: ","
	        });
	        
	        $("#nWasteProduced").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"yr", grid: false, prettify_separator: ","
	        });	        
	       	
	       	$("#nWasteRecycling").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"yr", grid: false, prettify_separator: ","
	        });
	       	
	       	$("#nWaterUsage").ionRangeSlider({
	            hide_min_max: true, min: 10, max: 150, step: 10, postfix:"yr", grid: false, prettify_separator: ","
	        });

	    });


		// sliders
		d3.select("#nEnergyDemand").on("input", function(){energyDemand = +this.value;});
		d3.select("#nEDFuel").on("input", function(){EDFuel = +this.value;}); // result of other sliders
		d3.select("#nEDPV").on("input", function(){EDPV = +this.value;});
		d3.select("#nEDBioMass").on("input", function(){EDBioMass = +this.value;});
		d3.select("#nEDWind").on("input", function(){EDWind = +this.value;});
		d3.select("#nFoodDemand").on("input", function(){FoodDemand = +this.value;});
		d3.select("#nFDGrains").on("input", function(){FDGrains = +this.value;}); // result of other sliders
		d3.select("#nFDVegetables").on("input", function(){FDVegetables = +this.value;});
		d3.select("#nFDFruit").on("input", function(){FDFruit = +this.value;});
		d3.select("#nFDDairy").on("input", function(){FDDairy = +this.value;});
		d3.select("#nFDMeat").on("input", function(){FDMeat = +this.value;});
		d3.select("#nFDFish").on("input", function(){FDFish = +this.value;});
		d3.select("#nMileDriven").on("input", function(){MileDriven = +this.value;});
		d3.select("#nVehicleEff").on("input", function(){VehicleEff = +this.value;});
		d3.select("#nGasolineMix").on("input", function(){GasolineMix = +this.value;});

	</script>


	<script type="text/javascript">

		var margin = { top: 10, right: 10, bottom: 0, left: 10 },
			width = window.innerWidth - 160;
			mapWidth = 7 * width /12 - margin.left - margin.right,
			height = window.innerHeight - 20,
			mapHeight = height - margin.top - margin.bottom,
			colors = ["#137484", "#00A3DB", "#9BD956", "#E6385C", "#F5EA0B", "#3ECA66"],
			landuse = ["Wetlands", "Water", "Natural", "Developed", "Agriculture", "Forest"],
			cityname = "", // a public value to be used to change population of cities on click
			showCityNames = false,
			originalPopulation = 0,
			totalPopulation = 0;

		// create population scale for circle radius
		var popScale = d3.scale.linear();

		// create color scale
		var colorscale = d3.scale.ordinal()
			.range(colors)
			.domain(landuse);

		//d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/settlements.json", function(settlements){
		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/settlements_LR.json", function(settlements){

		//d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/bitmapdata.json", function(data){
		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/bitmapdata_LR.json", function(data){
		

		// population table - Based on: http://christopheviau.com/d3_tutorial/
		settlements.forEach(function(d){
				totalPopulation += +d.population;
				originalPopulation += +d.population;
			});

		popScale.domain(d3.extent(settlements, function(d){return d.population;}));

		d3.select("#totalPopulation")
			.select("span")
			.text(totalPopulation)
			.style("font-size", "1.5em")
		    .style("color", "grey")
		    .style("font-weight", "bold");

		// start creating the map
		var numOfColumns = data.numOfCol;
		var gridSize = Math.min(mapHeight,mapWidth)/numOfColumns;
		var cells = data.cells;
		// total area in acres is 1581470
		var totalArea = 1581470;
		var cellArea = 1581470 / Math.pow(numOfColumns, 2);

		popScale.range([Math.min(8, 2*gridSize), Math.min(4, gridSize)]);
		
		// update height
		mapHeight = Math.max(mapHeight, mapWidth);
		
		// take care of whitespace in city names
		settlements.forEach(function(d){d.nospacename = d.name.replace(" ", "\\ ")});

		// create base svg and add group for grid
		var svg = d3.select("#grid").append("svg")
			.attr("width", mapWidth)
			.attr("height", mapHeight)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");			
		

		// add grid cells
		var grid = svg.selectAll("rect")
			.data(cells)
			.enter().append("rect")
				.attr("transform", function(d) {
					// set some other default values - I'm trying to save one extra loop by doing it here
					// not sure if it really helps
					d.isTaken = false;
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move cells to the right place
				.attr("width", gridSize)
				.attr("height", gridSize)
				.attr("class", "cells")
				.attr("id", function(d){return "id_" + d.id;})
				.style("fill",  function(d){return colorscale(d.landuse);})

		// animate loading the grid
		grid.transition().duration(2000)
			.attr("width", gridSize/2)
			.attr("height", gridSize/2);

		// Added tooltip to make sure x - y values make sense
		// grid.append("title").text(function(d){return d.x + "|" + d.y;})
		
      	/*
      	// Define drag beavior
	    var drag = d3.behavior.drag()
	        .on("drag", function(d) {
	            d.x += d3.event.dx;
	            d.y += d3.event.dy;
	            //this.x = d.x;
	            //this.y = d.y;
	            d3.select(this).attr("transform", function(d){
	                return "translate(" + [d.x, d.y] + ")"
	            })
	        });
		*/

		var hull = svg.append("path")
    		.attr("class", "hull");

		updatePopulation = function updatePopulation(){
						// re-calculate total population
			totalPopulation = 0;
			settlements.forEach(function(d){
				totalPopulation += +d.population;
			});

			var percentageChange = (100 * (totalPopulation-originalPopulation)/originalPopulation).toFixed(2);
			// update total population text
			d3.select("#totalPopulation").select('span').text(totalPopulation + "(" + percentageChange +"%)");

			// update population text
			d3.selectAll("text.populationText")
				.attr("y", function(d){return d.y - popScale(d.population)-5;})
				.text(function(d){return (d.name + ": " + d.population);});

			svg.selectAll("circle.cities")
				.attr("r", function(d){return popScale(d.population);})
		}

		// update population of the city
		updatePopulationOfTheCity = function updatePopulationOfTheCity() {
	        var thisCity = d3.select("#" + cityname);
	        var newPoulation = $("#new_population").val().trim();
	        $("#new_population").remove();
	        if (isNaN(parseInt(newPoulation))) return; // avoid invalid inputs
	        thisCity.data()[0].population = newPoulation;
			
			// update titles
			d3.selectAll(".cities").selectAll("title").text(function(d){return d.name + "> population: " + d.population;});

			updatePopulation();
	    }

	    removeInputPanel = function removeInputPanel(){
	        $("#new_population").remove();
	    }

		// add one circle for each city
		var cities = svg.selectAll("circle")
			.data(settlements)
			.enter().append("circle")
				.attr("class", "cities")
				.attr("id", function(d){return d.name;})
				.attr("r", function(d){return popScale(d.population);})
				.attr("transform", function(d) {
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move circles to the right place
				.style("fill", "white")
				.style("stroke", "black")
				.style("stroke-width", "2px")
      			//.call(drag)
      			// for this version we decided not to change the population which is pretty sad if you ask me!
      			.on("contextmenu", function(d) {
                    $(".externalObject").remove();
                    cityname = d.nospacename;
                    svg.append("foreignObject")
                        .attr("class", "externalObject")
                        .attr("x", d.x)
                        .attr("y", d.y)
                        .attr("width", 160)
                        .attr("height", 24)
                        .append("xhtml:div")
                        .html("<input type='text' id=new_population placeholder='input new population' onkeydown ='{if (event.keyCode==13)updatePopulationOfTheCity()}; if (event.keyCode==27) {removeInputPanel();}'></input>")
                        //found this example here: http://stackoverflow.com/questions/23503936/javascript-d3-create-floating-textbox-on-click-and-update-graph-from-textbox-in
                		d3.event.preventDefault(); //stop showing browser menu
                })
                .on("click", function(d){
                	// console.log(d.takenPoints);
                	// I think I will remove this from here to the end of each calculation so user can draw it all toghether if needed
                	hull.datum(d3.geom.hull(d.takenPoints)).attr("d", function(d) { return "M" + d.join("L") + "Z"; });
                });
      	
      	// add name and population of the cities to map
      	svg.selectAll("text")
			.data(settlements)
			.enter().append("text")
			.attr("class", "populationText")
			.attr("id", function(d){return d.name;})
      		.attr("x", function(d){return d.x;})
      		.attr("y", function(d){return d.y - popScale(d.population)-5;})
      		.style("fill", "black")
      		.style("text-anchor", "middle")
      		.style("font-size", "12px")
      		.style("font-weight", "bold")
      		.text(function(d){return (d.name + ": " + d.population);});

		// hide all of them for now

		if (showCityNames == false) d3.selectAll(".populationText").attr('visibility', 'hidden');

		d3.select("#showCities").on("click", function(){

			if (showCityNames == true){
				// hide them!
				svg.selectAll(".populationText").attr('visibility', 'hidden');
				showCityNames = false;
				d3.select("#showCities").transition().duration(1000).text("Show Population");
				svg.selectAll(".cells").transition().duration(1000).style("opacity", "1");
			}
			else
			{
				svg.selectAll(".populationText").attr('visibility', 'visible');
				showCityNames = true;
				d3.select("#showCities").transition().duration(1000).text("Hide Population");
				svg.selectAll(".cells").transition().duration(1000).style("opacity", ".3");
			}

		});

		// add mouse over tooltip
		cities.append("title").text(function(d){return d.name + "> population: " + d.population;})
		// append title for each cell for mouse hover
		// I think it is useful once they are taken by any of the cities
		// grid.append("title").text("some text")

		function getDistance(x0, y0, x1, y1){
			// this is not the correct distance but since I just use it for comparison
			// I'm trying to save the extra step of sqrt
			return Math.pow((x1-x0),2) + Math.pow((y1-y0),2);
		}

		// check scenario
		function checkScenario(){
			if (sumDietMixValues() != 1){
				alert("Sum of diet values should be equal to 1.00");
				return false;
			}
	       	
	       	if (sumEnergyMixValues() != 1){
	       		alert("Sum of energy mix values should be equal to 1.00");
	       		return false;
			}
			
			return true;
		}

		function resizeGird(callback) {
			setTimeout(function(){
				grid.transition()
	        		.duration(1000)
	        		.attr("width", gridSize/4)
	        		.attr("height", gridSize/2);
	        	
	        	if(typeof callback == 'function')
            		callback();
    			}, 1000);
		};

		// add a progress bar!
		function findResources(){
				var progBar = d3.select("#progBar")[0][0];
	        	var percentDone = 0;
	        	progBar.value = percentDone;

	        	// re-set taken points
	        	settlements.forEach(function(settlement){settlement.takenPoints = [];});

	        	// just for test running the first round
	        	for (var rank = 0; rank < 1; rank++) {
	        		settlements.forEach(function(settlement){
	        			var resources = settlement.sortedResourcesIds;
	        			var landuses = d3.keys(resources);
	        			
	        			landuses.forEach(function(landuse){
	        				var ids = resources[landuse][rank];
	        				percentDone += 1;
	        				progBar.value = percentDone;
		        			if(ids!=null){
	        					$('#progUpdate').empty().append(settlement.name + ": " + landuse);
		        				ids.forEach(function(id, i){
		        					d3.select("#id_" + id)
		        						.transition()
										.delay(function(d){
											// also push the point to taken points
											// I will use this to draw boundary for each city
											settlement.takenPoints.push([d.x + (gridSize/2), d.y + (gridSize/2)]);

											// manage delay in a way that it takes the same for all of cities?
											return (i + 2) * 20;})
		        						.duration(50)
		        						.attr("width", gridSize)
		        						.attr("height", gridSize);
		        						//.attr("fill", "black");
		        					//svg.append("line")

		        				});
	        				}
		        		// debugger;
	        			});
	        		});
	        	}

				if (percentDone>99) $('#progUpdate').empty().append("Calculation complete!");

		}

		// run the scenario
	    d3.select("#play")
	        .on("click", function() {
	        	
	        	if (!checkScenario())return;
				
				// I'm calling find resources inside resize grid to make sure
				// http://stackoverflow.com/questions/1859185/how-to-force-sequential-javascript-execution
				resizeGird(findResources);

	        });
	        	
    });

	});



	
	</script>


	<script data-cfasync="false" type="text/javascript">

	/*
		This is a very clean method, From this link to send data to google Spread Sheet:
		https://mashe.hawksey.info/2014/07/google-sheets-as-a-database-insert-with-apps-script-using-postget-methods-with-ajax-example
	*/
	
	jQuery( document ).ready(function( $ ) {

		// variable to hold request
		var request;
		// bind to the submit event of our form
		$("#inputSliders").submit(function(event){
			// abort any pending request
			if (request) {
				request.abort();
			}
			// setup some local variables
			var $form = $(this);
			
			// let's select and cache all the fields
			var $inputs = $form.find("input, select, button, textarea");
			
			// serialize the data in the form
			var serializedData = $form.serialize();
			
			console.log(serializedData);
			// let's disable the inputs for the duration of the ajax request
			// Note: we disable elements AFTER the form data has been serialized.
			// Disabled form elements will not be serialized.
			$inputs.prop("disabled", true);
			$('#result').text('    Sending data...');
		
			// fire off the request to /form.php
			request = $.ajax({
				url: "https://script.google.com/macros/s/AKfycbwyagcjP_5UD0emBo-MYepMLG3OEGZm815JpurpddezCd-VlWYT/exec",
				type: "post",
				data: serializedData
			});
		
			// callback handler that will be called on success
			request.done(function (response, textStatus, jqXHR){
				// log a message to the console
				$('#result').text(" Done!");
				console.log(response);
			});
		
			// callback handler that will be called on failure
			request.fail(function (jqXHR, textStatus, errorThrown){
				// log the error to the console
				console.error(
					"The following error occured: "+
					textStatus, errorThrown
				);
			});
		
			// callback handler that will be called regardless
			// if the request failed or succeeded
			request.always(function () {
				// reenable the inputs
				$inputs.prop("disabled", false);
			});
		
			// prevent default posting of form
			event.preventDefault();
		});
	});

	</script>

		<!--
	    <!-- /.footer
	    <div class="row-fluid">
	        <footer>
	            <div class="footer navbar-fixed-bottom col-xs-12">
	            <hr>
	                <p>
	                    March 2015 |
	                    <a href="https://github.com/mostaphaRoudsari/SettlementEmerge" target="_blank"> About</a>
	                </p>
	            </div>
	        </footer>
	    </div>
	    -->

	    <!-- jQuery Version 1.11.1 -->
	    <!-- <script src="base_bootstrap/js/jquery.js"></script> -->

	    <!-- Bootstrap Core JavaScript -->
	    <script src="base_bootstrap/js/bootstrap.min.js"></script>

</body>
	

</html>