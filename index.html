<!DOCTYPE html>

<html>

<style>
	body {
	   font-family: sans-serif;
	   font-size: 12px;
	}

	input {
	   font-family: sans-serif;
	   font-size: 8px;
	}
</style>

<head>
	<title>e[m]ergy settlement</title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script> <!-- D3 -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>

	<script src = "./js/pace.min.js"></script>	
	<style src = "./css/pace.css"></style>
</head>

<body>
	<p>Hover the mouse on circles to see name and population.<p>
	<p>Drag circles to relocate the cities - Right click to change population!<p>
	<p>Loading data will take few seconds...<p>
	<div id = "grid"></div>

	<script type="text/javascript">

		var margin = { top: 50, right: 20, bottom: 100, left: 30 },
			width = window.innerWidth - margin.left - margin.right,
			height = window.innerWidth - margin.top - margin.bottom,
			colors = ["#137484", "#00A3DB", "#9BD956", "#E6385C", "#F5EA0B", "#3ECA66"],
			landuse = ["Wetlands", "Water", "Natural", "Developed", "Agriculture", "Forest"],
			cityname = ""; // a public value to be used to change population of cities on click
		
		// create color scale
		var colorscale = d3.scale.ordinal()
			.range(colors)
			.domain(landuse);

		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/settlements.json", function(settlements){

		d3.json("https://dl.dropboxusercontent.com/u/16228160/D3TestData/bitmapdata.json", function(data){
		
		var numOfColumns = data.numOfCol;
		var gridSize = width/numOfColumns;
		var cells = data.cells;
		var cellArea = data.cellArea;

		// take care of whitespace in city names
		settlements.forEach(function(d){d.nospacename = d.name.replace(" ", "\\ ")});

		// create base svg and add group for grid
		var svg = d3.select("#grid").append("svg")
			.attr("width", width + margin.left + margin.right)
			.attr("height", height + margin.top + margin.bottom)
			.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");			
		
		// add grid cells
		var grid = svg.selectAll("rect")
			.data(cells)
			.enter().append("rect")
				.attr("transform", function(d) {
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move cells to the right place
				.attr("width", gridSize)
				.attr("height", gridSize)
				.attr("class", "cells")
				.attr("id", function(d){return d.id;})
				.style("fill", function(d){return colorscale(d.landuse);})

		// Added tooltip to make sure x - y values make sense
		// grid.append("title").text(function(d){return d.x + "|" + d.y;})
		
      	// Define drag beavior
	    var drag = d3.behavior.drag()
	        .on("drag", function(d) {
	            d.x += d3.event.dx;
	            d.y += d3.event.dy;
	            //this.x = d.x;
	            //this.y = d.y;
	            d3.select(this).attr("transform", function(d){
	                return "translate(" + [d.x, d.y] + ")"
	            })
	        });
		

		// update population of the city
		updatePopulation = function updatePopulation() {
	        var thisCity = d3.select("#" + cityname);
	        thisCity.data()[0].population = $("#new_population").val();
	        $("#new_population").remove();
			// update titles
			d3.selectAll(".cities").selectAll("title").text(function(d){return d.name + "> population: " + d.population;});
	    }

		// add one circle for each city
		var cities = svg.selectAll("circle")
			.data(settlements)
			.enter().append("circle")
				.attr("class", "cities")
				.attr("id", function(d){return d.name;})
				.attr("r", 2*gridSize)
				.attr("transform", function(d) {
					d.x = d.x * gridSize;
					d.y = d.y * gridSize;
					return "translate("+ [d.x, d.y] + ")";}) // move circles to the right place
				.style("fill", "black")
      			.call(drag)
      			.on("contextmenu", function(d) {
                    $(".externalObject").remove();
                    cityname = d.nospacename;
                    svg.append("foreignObject")
                        .attr("class", "externalObject")
                        .attr("x", d.x)
                        .attr("y", d.y)
                        .attr("width", width/6)
                        .attr("height", 18)
                        .append("xhtml:div")
                        .html("<input type='text' id=new_population placeholder='input new population' onchange=updatePopulation()></input>")
                        //found this example here: http://stackoverflow.com/questions/23503936/javascript-d3-create-floating-textbox-on-click-and-update-graph-from-textbox-in
                		d3.event.preventDefault(); //stop showing browser menu
                });
      	/*
      	// add name of cities
      	svg.selectAll("text")
			.data(settlements)
			.enter().append("text")
      		.attr("x", function(d){ return d.x;})
      		.attr("y", function(d){ return d.y - 2.1*gridSize;})
      		.style("fill", "black")
      		.style("font-size", "12px")
      		.text(function(d){return d.name;});
		*/

		// add mouse over tooltip
		cities.append("title").text(function(d){return d.name + "> population: " + d.population;})
		// append title for each cell for mouse hover
		// I think it is useful once they are taken by any of the cities
		// grid.append("title").text("some text")

		function getDistance(x0, y0, x1, y1){
			// this is not the correct distance but since I just use it for comparison
			// I'm trying to save the extra step of sqrt
			return Math.pow((x1-x0),2) + Math.pow((y1-y0),2);
		}
	})
})


	
	</script>

</body>
	

</html>